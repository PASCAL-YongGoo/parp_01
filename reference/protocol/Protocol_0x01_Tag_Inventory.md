# E310 RFID Protocol - Command 0x01: Tag Inventory

이 문서는 UHFEx10 사용자 매뉴얼 V2.20을 기반으로 **0x01 Tag Inventory** 명령어의 프로토콜 구조를 상세히 설명합니다.

## 1. Request Frame Format (PC → E310)

PC에서 E310 RFID 리더로 인벤토리 명령을 전송할 때 사용하는 프레임 구조입니다.

### 1.1. 전체 프레임 구조

| Len | Adr | Cmd | Data[] | CRC-16 |
| :-- | :-- | :-- | :-- | :-- |
| 1 byte | 1 byte | 1 byte | Variable | 2 bytes |

### 1.2. 필드 상세 설명

| 필드 | 길이 (byte) | 설명 |
| :--- | :--- | :--- |
| `Len` | 1 | `Data[]` 필드의 길이에 4를 더한 전체 커맨드 프레임의 길이입니다. |
| `Adr` | 1 | 리더의 주소 (0x00 ~ 0xFE). 0xFF는 브로드캐스트 주소입니다. |
| `Cmd` | 1 | 명령어 코드로, Tag Inventory는 **0x01** 입니다. |
| `Data[]` | 가변 | 인벤토리 수행에 필요한 파라미터들입니다. (아래 1.3. 참조) |
| `CRC-16` | 2 | `Len`부터 `Data[]`까지의 데이터에 대한 CRC-16 체크섬 (LSB, MSB 순) |

### 1.3. Data[] 필드 구조

| 파라미터 | 길이 (byte) | 설명 |
| :--- | :--- | :--- |
| `QValue` | 1 | **bit[7]**: 통계 데이터 패킷 플래그 (0: 비활성화, 1: 활성화)<br>**bit[6]**: 전략 표시자 (0: 일반, 1: 특별)<br>**bit[5]**: FastID 인벤토리 표시자 (0: 비활성화, 1: 활성화)<br>**bit[4]**: 위상 정보 (0: 비활성화, 1: 활성화)<br>**bit[3:0]**: Q-value (0-15). `2^Q`는 필드 내 태그 수와 비슷해야 합니다. |
| `Session` | 1 | EPC 태그 인벤토리의 세션 값 (0x00: S0, 0x01: S1, 0x02: S2, 0x03: S3, 0xFF: 스마트 설정). |
| `MaskMem` | 1 | 마스크 영역 지정 (0x01: EPC, 0x02: TID, 0x03: User). |
| `MaskAdr` | 2 | 마스크의 시작 비트 주소 (0-16383). |
| `MaskLen` | 1 | 마스크의 비트 길이. |
| `MaskData` | 가변 | 마스크 데이터. 길이는 `ceil(MaskLen/8)` 바이트입니다. |
| `AdrTID` | 1 | TID 메모리 인벤토리의 시작 주소. |
| `LenTID` | 1 | TID 인벤토리의 데이터 길이 (0-15). |
| `Target` | 1 (선택) | EPC 태그 인벤토리의 대상 (0x00: A, 0x01: B). |
| `Ant` | 1 (선택) | 안테나 선택 (0x80: 1번, 0x81: 2번, ..., 0x8F: 16번). |
| `ScanTime` | 1 (선택) | 인벤토리 시간 설정. `ScanTime * 100ms`로 계산됩니다. |

---

## 2. Response Frame Format (E310 → PC)

E310 리더가 PC로 인벤토리 결과를 응답할 때 사용하는 프레임 구조입니다. 응답은 `Status` 코드에 따라 두 가지 형태로 나뉩니다.

### 2.1. 통계 데이터 응답 (Status = 0x26)

`QValue`의 통계 데이터 패킷 플래그가 활성화된 경우, 인벤토리 종료 후 통계 정보를 응답합니다.

| Len | Adr | reCmd | Status | Data[] | CRC-16 |
| :-- | :-- | :-- | :-- | :-- | :-- |
| 1 byte | 1 byte | 1 byte | 1 byte | 7 bytes | 2 bytes |

| 필드 | 길이 (byte) | 설명 |
| :--- | :--- | :--- |
| `Status` | 1 | **0x26**: 인벤토리 후 통계 데이터를 전송함을 의미합니다. |
| `Ant` | 1 | 태그를 읽은 안테나를 표시합니다. |
| `ReadRate` | 2 | 태그 인식률 (tags/sec). |
| `TotalCount` | 4 | 현재 인벤토리에서 감지된 총 태그 수. |

### 2.2. 태그 데이터 응답 (Status != 0x26)

일반적인 태그 인벤토리 데이터 응답입니다.

| Len | Adr | reCmd | Status | Data[] | CRC-16 |
| :-- | :-- | :-- | :-- | :-- | :-- |
| 1 byte | 1 byte | 1 byte | 1 byte | Variable | 2 bytes |

| 필드 | 길이 (byte) | 설명 |
| :--- | :--- | :--- |
| `Status` | 1 | **0x01**: 작업 완료<br>**0x02**: 인벤토리 타임아웃<br>**0x03**: 전송할 데이터가 더 있음<br>**0x04**: 리더 메모리 가득 참<br>**0xF8**: 안테나 오류 |
| `Ant` | 1 | 태그를 읽은 안테나를 표시합니다. |
| `Num` | 1 | 응답에 포함된 RFID EPC/TID 데이터의 수. |
| `EPC ID` | 가변 | 조회된 EPC/TID 데이터. 감지된 태그마다 이 블록이 반복됩니다. |

### 2.3. EPC ID 상세 구조

`EPC ID` 블록의 상세 구조는 다음과 같습니다.

| Data length | Data | RSSI | phase (선택) | Freq(khz) (선택) |
| :--- | :--- | :--- | :--- | :--- |
| 1 byte | N bytes | 1 byte | 4 bytes | 3 bytes |

- **Data length**: **bit[7]** (0: EPC/TID, 1: EPC+TID), **bit[6]** (0: phase/freq 비활성화, 1: 활성화), **bit[5:0]** (Data 필드 길이 N).
- **Data**: EPC 또는 TID 데이터.
- **RSSI**: 태그 신호 강도.
- **phase**: 위상 정보 (활성화된 경우).
- **Freq(khz)**: 주파수 정보 (활성화된 경우).

---

## 3. 주요 파라미터 및 참고사항

- **Q value**: 0-15 범위. `2^Q`는 예상되는 태그 수와 비슷하게 설정하는 것이 좋습니다.
- **Session**: S0, S1, S2, S3. 다중 리더 환경에서 태그 식별을 관리하는 데 사용됩니다.
- **ScanTime**: 인벤토리 최대 수행 시간. `ScanTime * 100ms`로 계산됩니다.
- **CRC-16**: 다항식(Polynomial) `0x8408`, 초기값(Preset) `0xFFFF`를 사용하는 CRC-16-CCITT-FALSE 알고리즘으로 계산됩니다.
- **다중 태그 응답**: 한 프레임에 모든 태그 정보를 담을 수 없는 경우, `Status`가 `0x03`으로 설정되고 여러 프레임에 걸쳐 데이터가 전송됩니다.
- **오류 코드**:
  - `0x02`: 인벤토리 타임아웃. 설정된 시간 내에 작업을 완료하지 못함.
  - `0x04`: 리더 메모리 공간 부족.
  - `0xF8`: 안테나 연결 오류.
  - `0xFD`: 잘못된 프레임 길이.
  - `0xFE`: 잘못된 명령어 또는 CRC 오류.
  - `0xFF`: 인식할 수 없는 파라미터.
